name: Create Pull Request on merge in Deploy branch

on:
  pull_request:
    types:
      - closed
    branches: 
      - changelog_ci_testing

jobs:
  create_pull_request:
    if: ${{ github.event.pull_request.merged && !endsWith(github.event.pull_request.title, '[Auto-Generated]') }}
    runs-on: ubuntu-latest
    steps:        
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Fetch Pull Request Commits
        id: fetch_commits
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}"
          COMMITS=$(curl -sSL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" $API_URL | jq '.commits')
          
          echo "commit_count=$COMMITS" >> $GITHUB_OUTPUT
          
      - name: Display Commit Count
        run: |
          echo "Number of commits in the pull request: ${{ steps.fetch_commits.outputs.commit_count }}"
    
      - name: Check out git repository
        uses: actions/checkout@v3
        with:
          ref: changelog_ci_testing
          fetch-depth: ${{ steps.fetch_commits.outputs.commit_count }}
        
      - name: Set git username and user email
        run: |
          git config user.name "RohitFlyfin"
          git config user.email "rohitagarwal@flyfin.org"
      
      - name: Generate Changelog
        run: |
          yarn add generate-changelog
          yarn changelog -m
        
      - name: Get Version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@v1.3.1
  
      - name: Create a pull request
        uses: peter-evans/create-pull-request@v5
        with:
          base: changelog_ci_testing
          title: release ${{ steps.package-version.outputs.current-version }} [Auto-Generated]
          
  # temp 

      


    
